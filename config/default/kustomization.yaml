apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Adds namespace to all resources.
namespace: vault-config-operator

# Prefix for all resource names.
namePrefix: vault-config-operator-

resources:
  - ../crd
  - ../rbac
  - ../manager
  # [WEBHOOK] Enable if you have webhooks scaffolded.
  - ../webhook
  # [CERTMANAGER] Enable if you scaffolded cert-manager (requires WEBHOOK).
  # - ../certmanager
  # [PROMETHEUS] Enable if you have the prometheus bits.
  - ../prometheus

patches:
  # Protect /metrics behind auth.
  - path: manager_auth_proxy_patch.yaml
  # [WEBHOOK] Enable if you use webhooks.
  - path: manager_webhook_patch.yaml
  # [CERTMANAGER] Enable if you use cert-manager.
  # - path: webhookcainjection_patch.yaml
  # Uncomment the patches line if you enable Metrics and CertManager

  # [METRICS-WITH-CERTS] To enable metrics protected with certManager, uncomment the following line.
  # This patch will protect the metrics with certManager self-signed certs.
  #  - path: cert_metrics_manager_patch.yaml
  #    target:
  #      kind: Deployment

  # [WEBHOOK] To enable webhook, uncomment all the sections with [WEBHOOK] prefix including the one in
  # crd/kustomization.yaml
#  - path: manager_webhook_patch.yaml
#    target:
#      kind: Deployment

# Kustomize v5 replacement transformer (vars are deprecated).
replacements:
  # --- Metrics service name -> Deployment env[0].value ---
  - source:
      group: ""          # core
      version: v1
      kind: Service
      name: controller-manager-metrics-service
      fieldPath: metadata.name
    targets:
      - select:
          group: apps
          version: v1
          kind: Deployment
          name: controller-manager
        fieldPaths:
          - spec.template.spec.containers.0.env.0.value
        options:
          create: true

  # --- Metrics service namespace -> Deployment env[1].value ---
  - source:
      group: ""          # core
      version: v1
      kind: Service
      name: controller-manager-metrics-service
      fieldPath: metadata.namespace
    targets:
      - select:
          group: apps
          version: v1
          kind: Deployment
          name: controller-manager
        fieldPaths:
          - spec.template.spec.containers.0.env.1.value
        options:
          create: true

  # --- Prometheus Role name -> RoleBinding roleRef.name ---
  - source:
      group: rbac.authorization.k8s.io
      version: v1
      kind: Role
      name: prometheus-k8s
      fieldPath: metadata.name
    targets:
      - select:
          group: rbac.authorization.k8s.io
          version: v1
          kind: RoleBinding
          name: prometheus-k8s-rolebinding
        fieldPaths:
          - roleRef.name

  # - source: # Uncomment the following block to enable certificates for metrics
  #     kind: Service
  #     version: v1
  #     name: controller-manager-metrics-service
  #     fieldPath: metadata.name
  #   targets:
  #     - select:
  #         kind: Certificate
  #         group: cert-manager.io
  #         version: v1
  #         name: metrics-certs
  #       fieldPaths:
  #         - spec.dnsNames.0
  #         - spec.dnsNames.1
  #       options:
  #         delimiter: '.'
  #         index: 0
  #         create: true
  #     - select: # Uncomment the following to set the Service name for TLS config in Prometheus ServiceMonitor
  #         kind: ServiceMonitor
  #         group: monitoring.coreos.com
  #         version: v1
  #         name: controller-manager-metrics-monitor
  #       fieldPaths:
  #         - spec.endpoints.0.tlsConfig.serverName
  #       options:
  #         delimiter: '.'
  #         index: 0
  #         create: true
  #
  # - source:
  #     kind: Service
  #     version: v1
  #     name: controller-manager-metrics-service
  #     fieldPath: metadata.namespace
  #   targets:
  #     - select:
  #         kind: Certificate
  #         group: cert-manager.io
  #         version: v1
  #         name: metrics-certs
  #       fieldPaths:
  #         - spec.dnsNames.0
  #         - spec.dnsNames.1
  #       options:
  #         delimiter: '.'
  #         index: 1
  #         create: true
  #     - select: # Uncomment the following to set the Service namespace for TLS in Prometheus ServiceMonitor
  #         kind: ServiceMonitor
  #         group: monitoring.coreos.com
  #         version: v1
  #         name: controller-manager-metrics-monitor
  #       fieldPaths:
  #         - spec.endpoints.0.tlsConfig.serverName
  #       options:
  #         delimiter: '.'
  #         index: 1
  #         create: true
  #
  # - source: # Uncomment the following block if you have any webhook
  #     kind: Service
  #     version: v1
  #     name: webhook-service
  #     fieldPath: .metadata.name # Name of the service
  #   targets:
  #     - select:
  #         kind: Certificate
  #         group: cert-manager.io
  #         version: v1
  #         name: serving-cert
  #       fieldPaths:
  #         - .spec.dnsNames.0
  #         - .spec.dnsNames.1
  #       options:
  #         delimiter: '.'
  #         index: 0
  #         create: true
  # - source:
  #     kind: Service
  #     version: v1
  #     name: webhook-service
  #     fieldPath: .metadata.namespace # Namespace of the service
  #   targets:
  #     - select:
  #         kind: Certificate
  #         group: cert-manager.io
  #         version: v1
  #         name: serving-cert
  #       fieldPaths:
  #         - .spec.dnsNames.0
  #         - .spec.dnsNames.1
  #       options:
  #         delimiter: '.'
  #         index: 1
  #         create: true
  #
  # - source:
  #     group: ""      # core
  #     version: v1
  #     kind: Service
  #     name: webhook-service
  #     fieldPath: metadata.namespace
  #   targets:
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: MutatingWebhookConfiguration
  #         name: mutating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.namespace
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: ValidatingWebhookConfiguration
  #         name: validating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.namespace
  #
  # - source:
  #     group: ""      # core
  #     version: v1
  #     kind: Service
  #     name: webhook-service
  #     fieldPath: metadata.name
  #   targets:
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: MutatingWebhookConfiguration
  #         name: mutating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.name
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: ValidatingWebhookConfiguration
  #         name: validating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.name

  # +kubebuilder:scaffold:crdkustomizecainjectionns
  # - source:   # example (keep commented)
  #     group: ""      # core
  #     version: v1
  #     kind: Service
  #     name: webhook-service
  #     fieldPath: metadata.namespace
  #   targets:
  #     - select:
  #         group: apiextensions.k8s.io
  #         version: v1
  #         kind: CustomResourceDefinition
  #         name: <plural>.<group>   # e.g., vaultsecrets.redhatcop.redhat.io
  #       fieldPaths:
  #         - spec.conversion.webhook.clientConfig.service.namespace
  #       options:
  #         create: true
