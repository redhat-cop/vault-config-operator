apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Adds namespace to all resources.
namespace: vault-config-operator

# Prefix for all resource names.
namePrefix: vault-config-operator-

resources:
  - ../crd
  - ../rbac
  - ../manager
  # [WEBHOOK] Enable if you have webhooks scaffolded.
  - ../webhook
  # [CERTMANAGER] Enable if you scaffolded cert-manager (requires WEBHOOK).
  # - ../certmanager
  # [PROMETHEUS] Enable if you have the prometheus bits.
  - ../prometheus

patches:
  # Protect /metrics behind auth.
  - path: manager_auth_proxy_patch.yaml
  # [WEBHOOK] Enable if you use webhooks.
  - path: manager_webhook_patch.yaml
  # [CERTMANAGER] Enable if you use cert-manager.
  # - path: webhookcainjection_patch.yaml

# Kustomize v5 replacement transformer (vars are deprecated).
replacements:
  # --- Metrics service name -> Deployment env[0].value ---
  - source:
      group: ""          # core
      version: v1
      kind: Service
      name: controller-manager-metrics-service
      fieldPath: metadata.name
    targets:
      - select:
          group: apps
          version: v1
          kind: Deployment
          name: controller-manager
        fieldPaths:
          - spec.template.spec.containers.0.env.0.value
        options:
          create: true

  # --- Metrics service namespace -> Deployment env[1].value ---
  - source:
      group: ""          # core
      version: v1
      kind: Service
      name: controller-manager-metrics-service
      fieldPath: metadata.namespace
    targets:
      - select:
          group: apps
          version: v1
          kind: Deployment
          name: controller-manager
        fieldPaths:
          - spec.template.spec.containers.0.env.1.value
        options:
          create: true

  # --- Prometheus Role name -> RoleBinding roleRef.name ---
  - source:
      group: rbac.authorization.k8s.io
      version: v1
      kind: Role
      name: prometheus-k8s
      fieldPath: metadata.name
    targets:
      - select:
          group: rbac.authorization.k8s.io
          version: v1
          kind: RoleBinding
          name: prometheus-k8s-rolebinding
        fieldPaths:
          - roleRef.name

  # [CERTMANAGER] If you enable cert-manager, uncomment these:
  # - source:
  #     group: cert-manager.io
  #     version: v1
  #     kind: Certificate
  #     name: serving-cert
  #     fieldPath: metadata.namespace
  #   targets:
  #     - select:
  #         group: apps
  #         version: v1
  #         kind: Deployment
  #         name: controller-manager
  #       fieldPaths:
  #         - spec.template.spec.containers.0.env.2.value
  #       options:
  #         create: true
  #
  # - source:
  #     group: ""      # core
  #     version: v1
  #     kind: Service
  #     name: webhook-service
  #     fieldPath: metadata.namespace
  #   targets:
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: MutatingWebhookConfiguration
  #         name: mutating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.namespace
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: ValidatingWebhookConfiguration
  #         name: validating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.namespace
  #
  # - source:
  #     group: ""      # core
  #     version: v1
  #     kind: Service
  #     name: webhook-service
  #     fieldPath: metadata.name
  #   targets:
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: MutatingWebhookConfiguration
  #         name: mutating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.name
  #     - select:
  #         group: admissionregistration.k8s.io
  #         version: v1
  #         kind: ValidatingWebhookConfiguration
  #         name: validating-webhook-configuration
  #       fieldPaths:
  #         - webhooks.0.clientConfig.service.name
